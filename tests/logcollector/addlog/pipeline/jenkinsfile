

node("ansible"){
  stage("STAGE 0 - Setting environment"){
    git branch: 'master', url: 'https://github.com/okynos/wazuh-QA.git'
    sh "mkdir -p tmp"
    sh "python tools/generateJSON.py deployments/structure.json deployments/default/deploy.json > tmp/standard_deploy.json"
    sh "python tools/generateInventory.py deploy tmp/standard_deploy.json > tmp/hosts_deploy"
    sh "python tools/generateInventory.py config tmp/standard_deploy.json > tmp/hosts_config"
  }

  stage("STAGE 1 - Deploy"){
    sh "ansible-playbook -i tmp/hosts_deploy deployments/deploy.yaml"
    sh "ansible-playbook -i tmp/hosts_config common-provision/conf-wazuh.yaml"
  }

  stage("STAGE 2 - Test"){
    
    sh "ansible-playbook -i tmp/hosts_config tests/logcollector/addlog/configuration/test_agent.yml"
    sh "ansible-playbook -i tmp/hosts_config tests/logcollector/addlog/configuration/test_manager.yml"
  }

  stage("STAGE X - Destroy"){
    sh "ansible-playbook -i tmp/hosts_deploy deployments/destroy.yaml"
  }

}
