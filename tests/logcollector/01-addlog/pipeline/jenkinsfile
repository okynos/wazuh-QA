# Configuration
def tmp_path = "tmp"
def deploy_path = "deployments/ansible"
def hosts_deploy = "$tmp_path/hosts_deploy"
def hosts_config = "$tmp_path/hosts_config"
def selected_deploy = "$tmp_path/selected_deploy.json"
def infrastructure = "$deploy_path/conf/structure.json"
def deploy_conf = "$deploy_path/default.json"
def test_route = "tests/logcollector/01-addlog/test/conf"
def keys_path = "/root/keys"
def jenkins_repo = "https://github.com/okynos/wazuh-QA.git"
def jenkins_branch = "master"

# Parameters from Jenkins
def version = global.determine_os(params.wazuh-version)
def branch = global.determine_os(params.branch)
def installation = global.determine_os(params.installation)

node("ansible"){
  stage("STAGE 0 - Setting environment"){
    git branch: "$jenkins_branch", url: "$jenkins_repo"
    sh "mkdir -p $tmp_path"
    sh "cp $keys_path/* $tmp_path/"
    sh "python tools/generateJSON.py $infrastructure $deploy_conf > $selected_deploy"
    sh "python tools/generateInventory.py deploy $selected_deploy > $hosts_deploy"
    sh "python tools/generateInventory.py config $selected_deploy > $hosts_config"
  }

  stage("STAGE 1 - Deploy"){
    sh "ansible-playbook -i $hosts_deploy $deploy_path/conf/deploy.yaml"
    sh "ansible-playbook -i $hosts_config $deploy_path/conf/conf-wazuh.yaml --extra-vars 'wazuh_version=$version'"
  }

  stage("STAGE 2 - Test"){
    
    sh "ansible-playbook -i $hosts_config $test_route/test_agent.yml"
    sh "ansible-playbook -i $hosts_config $tests_route/test_manager.yml"
  }

  stage("STAGE X - Destroy"){
    sh "ansible-playbook -i $hosts_deploy $deploy_path/conf/destroy.yaml"
  }

}
