// Configuration
def deploy_path = "deployments/ansible"
def deploy_conf = "$deploy_path/1m-c_1a-u.json"
def test_route = "tests/logcollector/14-check_captured_command/test/conf"
def environment = "environments/env-docker"
def env_file = "$environment/environment.json"

// Pipeline configuration
def jenkins_repo = "https://github.com/okynos/wazuh-QA.git"
def jenkins_branch = "master"
def keys_path = "/home/okynos/jenkins/keys"

// Temporal output
def tmp_path = "tmp"
def hosts_deploy = "$tmp_path/hosts_deploy"
def hosts_config = "$tmp_path/hosts_config"
def selected_deploy = "$tmp_path/selected_deploy.json"

// Parameters from Jenkins
def version = params.wazuh_version
def branch = params.branch
def installation = params.installation

node("ansible"){
  stage("STAGE 0 - Initializing environment"){
    sh "rm -rf $tmp_path"
    git branch: "$jenkins_branch", url: "$jenkins_repo"
    sh "mkdir -p $tmp_path"
    sh "cp $keys_path/* $tmp_path/"
    sh "chmod 0400 $tmp_path/id_rsa*"
    sh "python tools/generateJSON.py $env_file $deploy_conf > $selected_deploy"
    sh "python tools/generateInventory.py deploy $selected_deploy > $hosts_deploy"
    sh "python tools/generateInventory.py config $selected_deploy > $hosts_config"
  }

  stage("STAGE 1 - Deploy"){
    sh "ansible-playbook -i $hosts_deploy $deploy_path/conf/deploy.yaml"
    sh "ansible-playbook -i $hosts_config $deploy_path/conf/wazuh_packages_install.yaml --extra-vars 'wazuh_version=$version'"
    sh "ansible-playbook -i $hosts_config $deploy_path/conf/wazuh_register.yaml"
  }

  stage("STAGE 2 - Running test"){ 
    sh "ansible-playbook -i $hosts_config $test_route/test_agent.yaml"
    sh "ansible-playbook -i $hosts_config $test_route/test_manager.yaml"
  }

  stage("STAGE X - Destroy"){
    sh "ansible-playbook -i $hosts_deploy $deploy_path/conf/destroy.yaml"
  }

}
